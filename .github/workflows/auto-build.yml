name: Auto Build WiFi Share APK

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/workflows/test-minimal.yml'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==1.5.0 cython
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}-v3
        restore-keys: |
          buildozer-global-${{ hashFiles('buildozer.spec') }}-
          buildozer-global-
    
    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-v3
        restore-keys: |
          ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-
          ${{ runner.os }}-buildozer-
    
    - name: Set build environment
      run: |
        export BUILDOZER_GLOBAL_DIR="$(pwd)/.buildozer_global"
        echo "BUILDOZER_GLOBAL_DIR=$BUILDOZER_GLOBAL_DIR" >> $GITHUB_ENV
    
    - name: Build APK
      run: |
        echo "Building debug APK..."
        buildozer android debug
    
    - name: List build output
      run: |
        echo "=== Build Output ==="
        ls -la bin/ || echo "No bin directory found"
        echo ""
        echo "=== APK Files ==="
        find . -name "*.apk" -type f -exec ls -lh {} \;
    
    - name: Rename APK with version info
      if: success()
      run: |
        cd bin
        for apk in *.apk; do
          if [ -f "$apk" ]; then
            # Get version from buildozer.spec
            version=$(grep "^version" ../buildozer.spec | cut -d'=' -f2 | tr -d ' ')
            # Get short commit hash
            commit=$(git rev-parse --short HEAD)
            # Create new filename
            new_name="wifishare-v${version}-${commit}-debug.apk"
            mv "$apk" "$new_name"
            echo "Renamed $apk to $new_name"
          fi
        done
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: wifishare-apk-debug
        path: bin/*.apk
        retention-days: 30
    
    - name: Upload build logs on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-failed
        path: |
          .buildozer/android/platform/build-*/logs/
          .buildozer/android/logs/
        retention-days: 7
